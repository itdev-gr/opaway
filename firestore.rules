rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: check if the requesting user is an admin
    function isAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.type == 'admin';
    }

    // ── Users ──────────────────────────────────────────────────────────────
    match /users/{userId} {
      // Every authenticated user can read & write their own document
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Admins can read and update any user document (e.g. change roles)
      allow read, write: if isAdmin();
    }

    // ── Transfers ──────────────────────────────────────────────────────────
    match /transfers/{docId} {
      // Any authenticated user can create a booking
      allow create: if request.auth != null;
      // Only the owner can read their own booking
      allow read: if request.auth != null && request.auth.uid == resource.data.uid;
      // Admins can read, update, and delete all transfers
      allow read, write: if isAdmin();
    }

    // ── Tours ──────────────────────────────────────────────────────────────
    match /tours/{docId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && request.auth.uid == resource.data.uid;
      allow read, write: if isAdmin();
    }

    // ── Experiences ────────────────────────────────────────────────────────
    match /experiences/{docId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && request.auth.uid == resource.data.uid;
      allow read, write: if isAdmin();
    }

    // ── Transfers Catalog (public read, admin write) ────────────────────
    match /transfersCatalog/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ── Tours Catalog (public read, admin write) ────────────────────────
    match /toursCatalog/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ── Experiences Catalog (public read, admin write) ──────────────────
    match /experiencesCatalog/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ── Requests (public create, admin read/write) ───────────────────────
    // Anyone (including unauthenticated visitors) can submit a tour booking
    // or contact form. Only admins can read and manage requests.
    match /requests/{docId} {
      allow create: if true;
      allow read, write: if isAdmin();
    }

    // ── Partners ──────────────────────────────────────────────────────────
    // A partner can read & write their own document (keyed by uid).
    // type field: 'hotel' | 'agency' | 'driver'
    // Only admins can read and manage all partner documents.
    match /partners/{partnerId} {
      allow create: if request.auth != null && request.auth.uid == partnerId;
      allow read, write: if request.auth != null && request.auth.uid == partnerId;
      allow read, write: if isAdmin();
    }

  }
}
