---
---

<nav transition:persist class="absolute top-0 left-0 right-0 z-50 bg-white/80 text-black font-sans flex items-center justify-between px-6 py-1 lg:px-10">
	<!-- Logo -->
	<a href="/" class="flex items-center shrink-0" aria-label="Opawey - Αρχική">
		<img src="/logo-opawey.png" alt="Opawey" class="h-24 w-auto object-contain" width="280" height="96" />
	</a>

	<!-- Center nav links -->
	<div class="hidden md:flex items-center gap-8 flex-1 justify-center font-medium tracking-wide">

		<a href="/" data-navlink data-href="/"
			class="pb-0.5 border-b-2 border-transparent text-black hover:text-black/70 hover:border-black/30 transition-colors duration-300">
			HOME
		</a>

		<a href="/about" data-navlink data-href="/about"
			class="pb-0.5 border-b-2 border-transparent text-black hover:text-black/70 hover:border-black/30 transition-colors duration-300">
			ABOUT US
		</a>

		<!-- BOOK ONLINE — hover dropdown -->
		<div class="relative group">
			<button
				data-navlink
				data-href="/book"
				class="flex items-center gap-1 pb-0.5 border-b-2 border-transparent text-black hover:text-black/70 hover:border-black/30 transition-colors duration-300 cursor-default select-none"
			>
				BOOK ONLINE
				<svg class="w-3.5 h-3.5 mt-0.5 transition-transform duration-200 group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" aria-hidden="true">
					<path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
				</svg>
			</button>

			<!-- Dropdown panel -->
			<div class="absolute top-full left-1/2 -translate-x-1/2 pt-4 opacity-0 invisible translate-y-1 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 transition-all duration-200 z-50">
				<!-- little arrow pointer -->
				<div class="absolute top-2.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-white border-l border-t border-neutral-100 rotate-45 shadow-[-1px_-1px_0_0_#f3f4f6]"></div>
				<div class="bg-white rounded-2xl shadow-xl border border-neutral-100 overflow-hidden p-2 min-w-[230px]">

					<!-- Book a Transfer -->
					<a href="/book/transfer" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-sky-50 transition-colors duration-150 group/item">
						<div class="w-9 h-9 rounded-xl bg-[#0C6B95]/10 flex items-center justify-center shrink-0 group-hover/item:bg-[#0C6B95]/15 transition-colors">
							<svg class="w-4 h-4 text-[#0C6B95]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
							</svg>
						</div>
						<div>
							<div class="font-semibold text-sm text-neutral-900 group-hover/item:text-[#0C6B95] transition-colors">Book a Transfer</div>
							<div class="text-xs text-neutral-400 mt-0.5">Airport pickups & city transfers</div>
						</div>
					</a>

					<!-- Book a Tour -->
					<a href="/book/tour" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-sky-50 transition-colors duration-150 group/item">
						<div class="w-9 h-9 rounded-xl bg-[#0C6B95]/10 flex items-center justify-center shrink-0 group-hover/item:bg-[#0C6B95]/15 transition-colors">
							<svg class="w-4 h-4 text-[#0C6B95]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
							</svg>
						</div>
						<div>
							<div class="font-semibold text-sm text-neutral-900 group-hover/item:text-[#0C6B95] transition-colors">Book a Tour</div>
							<div class="text-xs text-neutral-400 mt-0.5">Wine tastings & curated experiences</div>
						</div>
					</a>

				</div>
			</div>
		</div>

		<a href="/experiences" data-navlink data-href="/experiences"
			class="pb-0.5 border-b-2 border-transparent text-black hover:text-black/70 hover:border-black/30 transition-colors duration-300">
			EXPERIENCES
		</a>

		<a href="/contact" data-navlink data-href="/contact"
			class="pb-0.5 border-b-2 border-transparent text-black hover:text-black/70 hover:border-black/30 transition-colors duration-300">
			CONTACT
		</a>

	</div>

	<!-- Right: Profile icon + Sign-in (guest) or Profile link (logged-in) -->
	<div class="flex items-center gap-3 shrink-0">
		<!-- Guest: profile icon + Sign in -->
		<div id="nav-auth-guest" class="flex items-center gap-3">
			<a href="/login" aria-label="My Account" class="w-10 h-10 rounded-full border-2 border-neutral-200 bg-white hover:border-[#0C6B95] hover:bg-sky-50 flex items-center justify-center transition-colors duration-200">
				<svg class="w-5 h-5 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.8" aria-hidden="true">
					<circle cx="12" cy="8" r="4" stroke-linecap="round" stroke-linejoin="round"/>
					<path stroke-linecap="round" stroke-linejoin="round" d="M4 20c0-4 3.582-7 8-7s8 3 8 7"/>
				</svg>
			</a>
			<a href="/login" class="inline-flex items-center gap-2 bg-black text-white font-medium px-5 py-2.5 rounded-full hover:bg-neutral-800 transition-colors">
				Sign in
			</a>
		</div>
		<!-- Logged-in: Admin (if admin) + user name + profile link (hidden by default) -->
		<div id="nav-auth-user" class="hidden">
			<div class="flex items-center gap-3">
			<a id="nav-admin-btn" href="/admin" class="hidden items-center gap-2 bg-[#0C6B95] text-white font-medium px-4 py-2 rounded-full hover:bg-[#0a5c82] transition-colors text-sm shrink-0" aria-label="Admin">Admin</a>
			<span id="nav-user-name" class="text-sm font-medium text-neutral-700 truncate max-w-[140px] sm:max-w-[180px]" title=""></span>
			<a href="/profile" aria-label="My profile" class="w-10 h-10 rounded-full border-2 border-neutral-200 bg-white hover:border-[#0C6B95] hover:bg-sky-50 flex items-center justify-center transition-colors duration-200 shrink-0">
				<svg class="w-5 h-5 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.8" aria-hidden="true">
					<circle cx="12" cy="8" r="4" stroke-linecap="round" stroke-linejoin="round"/>
					<path stroke-linecap="round" stroke-linejoin="round" d="M4 20c0-4 3.582-7 8-7s8 3 8 7"/>
				</svg>
			</a>
			</div>
		</div>
	</div>
</nav>

<script>
	import { auth, db } from '../lib/firebase';
	import { onAuthStateChanged } from 'firebase/auth';
	import { doc, getDocFromServer } from 'firebase/firestore';

	function updateActiveLink() {
		const pathname = window.location.pathname;
		document.querySelectorAll('[data-navlink]').forEach((el) => {
			const link = el as HTMLElement;
			const href = link.getAttribute('data-href') ?? '';
			const isActive = href === '/' ? pathname === '/' : pathname.startsWith(href);
			link.classList.toggle('border-black', isActive);
			link.classList.toggle('border-transparent', !isActive);
		});
	}

	async function updateAuthNav(user: { uid: string; displayName?: string | null; email?: string | null } | null) {
		const guest = document.getElementById('nav-auth-guest');
		const userEl = document.getElementById('nav-auth-user');
		const nameEl = document.getElementById('nav-user-name');
		const adminBtn = document.getElementById('nav-admin-btn');
		if (guest) guest.classList.toggle('hidden', !!user);
		if (userEl) userEl.classList.toggle('hidden', !user);
		// Admin button: hidden by default; show only when Firestore user.type === 'admin'
		if (adminBtn) { adminBtn.classList.add('hidden'); adminBtn.classList.remove('inline-flex'); }
		if (nameEl && user) {
			nameEl.textContent = user.displayName?.trim() || user.email || 'Account';
			nameEl.setAttribute('title', nameEl.textContent);
			try {
				const snap = await getDocFromServer(doc(db, 'users', user.uid));
				if (snap.exists()) {
					const data = snap.data();
					const displayName = data?.displayName as string | undefined;
					if (displayName && typeof displayName === 'string' && displayName.trim()) {
						nameEl.textContent = displayName.trim();
						nameEl.setAttribute('title', displayName.trim());
					}
					// Show Admin only when type is exactly string 'admin'; user, undefined, or any other type → hidden
					const isAdmin = data?.type === 'admin';
					// eslint-disable-next-line no-console -- temporary debug: verify Firestore type for current user
					console.log('Navbar user type:', data?.type, 'uid:', user.uid);
					if (!adminBtn) return;
					// When not admin: always hide (so we never leave it visible from a stale state).
					// When admin: only show if this response is for the current user (stale check).
					if (!isAdmin) {
						adminBtn.classList.add('hidden');
						adminBtn.classList.remove('inline-flex');
					} else if (auth.currentUser?.uid === user.uid) {
						adminBtn.classList.remove('hidden');
						adminBtn.classList.add('inline-flex');
					}
				}
			} catch {
				// Keep fallback from Auth; admin stays hidden
			}
		}
	}

	onAuthStateChanged(auth, updateAuthNav);

	// Run on first load
	updateActiveLink();

	// Re-run on every View Transitions page navigation
	document.addEventListener('astro:page-load', () => {
		updateActiveLink();
		updateAuthNav(auth.currentUser);
	});
</script>
