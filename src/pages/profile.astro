---
import ProfileLayout from '../components/ProfileLayout.astro';
---

<ProfileLayout>
	<div class="relative z-10 w-full flex-1 min-h-0 flex flex-col">
		<!-- Profile content (white box): starts below nav, named for reference -->
		<div class="profile-content flex-1 min-h-0 flex flex-col bg-white rounded-3xl border border-neutral-200 shadow-xl shadow-neutral-200/60 p-8 lg:p-10 overflow-auto" aria-label="Profile content">
			<div id="profile-loading" class="text-center py-8 text-neutral-500 text-sm min-h-[120px]"></div>

			<div id="profile-content" class="hidden">
				<div class="mb-8">
					<div class="flex items-center gap-2 mb-3">
						<span class="w-2 h-2 rounded-full bg-[#0C6B95] shrink-0"></span>
						<span class="text-xs font-medium text-[#0C6B95] tracking-widest uppercase">My Account</span>
					</div>
					<h1 class="text-3xl font-bold text-neutral-900">Profile</h1>
					<p class="text-neutral-500 text-sm mt-1">Your account details.</p>
				</div>

				<div id="profile-avatar-wrap" class="hidden">
					<div class="flex justify-center mb-6">
						<img id="profile-avatar" src="" alt="" class="w-20 h-20 rounded-full object-cover border-2 border-neutral-200" />
					</div>
				</div>

				<div class="flex flex-col gap-1.5 mb-5">
					<label class="text-neutral-700 text-xs font-medium uppercase tracking-widest">Name</label>
					<p id="profile-display-name" class="py-3 px-4 bg-neutral-50 border border-neutral-200 rounded-xl text-neutral-800 text-sm"></p>
				</div>

				<div class="flex flex-col gap-1.5 mb-8">
					<label class="text-neutral-700 text-xs font-medium uppercase tracking-widest">Email</label>
					<p id="profile-email" class="py-3 px-4 bg-neutral-50 border border-neutral-200 rounded-xl text-neutral-800 text-sm"></p>
				</div>

				<button
					type="button"
					id="profile-sign-out"
					class="w-full py-3.5 bg-neutral-900 hover:bg-neutral-800 text-white font-semibold rounded-xl transition-colors duration-200 flex items-center justify-center gap-2"
				>
					Sign out
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
					</svg>
				</button>
			</div>
		</div>
	</div>
</ProfileLayout>

<script>
	import { auth } from '../lib/firebase';
	import { onAuthStateChanged, signOut } from 'firebase/auth';

	const loadingEl = document.getElementById('profile-loading');
	const contentEl = document.getElementById('profile-content');
	const avatarWrap = document.getElementById('profile-avatar-wrap');
	const avatarImg = document.getElementById('profile-avatar') as HTMLImageElement | null;
	const displayNameEl = document.getElementById('profile-display-name');
	const emailEl = document.getElementById('profile-email');
	const signOutBtn = document.getElementById('profile-sign-out');

	const doSignOut = async () => {
		try {
			await signOut(auth);
			window.location.href = '/';
		} catch {
			window.location.href = '/';
		}
	};
	signOutBtn?.addEventListener('click', doSignOut);

	onAuthStateChanged(auth, (user) => {
		if (!user) {
			window.location.href = '/login';
			return;
		}
		if (loadingEl) loadingEl.classList.add('hidden');
		if (contentEl) contentEl.classList.remove('hidden');
		if (displayNameEl) displayNameEl.textContent = user.displayName?.trim() || '—';
		if (emailEl) emailEl.textContent = user.email || '—';
		if (user.photoURL && avatarWrap && avatarImg) {
			avatarImg.src = user.photoURL;
			avatarImg.alt = user.displayName || 'Profile photo';
			avatarWrap.classList.remove('hidden');
		}
	});
</script>
