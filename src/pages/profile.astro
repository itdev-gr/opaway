---
import Layout from '../layouts/Layout.astro';
---

<Layout>
	<main class="flex min-h-screen bg-sky-50">
		<!-- Mobile overlay when sidebar open -->
		<div id="profile-sidebar-overlay" class="fixed inset-0 bg-black/40 z-30 hidden md:hidden" aria-hidden="true"></div>

		<!-- Burger button (mobile only) -->
		<button
			type="button"
			id="profile-burger"
			class="fixed top-4 right-4 z-50 md:hidden w-12 h-12 rounded-full bg-violet-800 text-white flex items-center justify-center shadow-lg hover:bg-violet-700 transition-colors"
			aria-label="Open menu"
		>
			<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
				<path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
			</svg>
		</button>

		<!-- Sidebar -->
		<aside
			id="profile-sidebar"
			class="fixed top-0 left-0 z-40 h-full w-72 bg-violet-800 flex flex-col -translate-x-full md:translate-x-0 transition-transform duration-300 ease-out"
		>
			<!-- Nav links (side menu starts from Home) -->
			<nav class="flex-1 pt-6 py-4 px-4 flex flex-col">
				<a href="/" class="py-3 px-3 text-white hover:bg-white/10 rounded-lg transition-colors border-b border-white/10">Home</a>
				<a href="/about" class="py-3 px-3 text-white hover:bg-white/10 rounded-lg transition-colors border-b border-white/10">About Us</a>
				<div class="relative group/book border-b border-white/10">
					<a href="/book" class="flex items-center justify-between py-3 px-3 text-white hover:bg-white/10 rounded-lg transition-colors">
						<span>Book Online</span>
						<svg class="w-4 h-4 transition-transform group-hover/book:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
						</svg>
					</a>
					<div class="pl-3 pb-2">
						<a href="/book/transfer" class="block py-1.5 text-sm text-white/90 hover:text-white">Book a Transfer</a>
						<a href="/book/tour" class="block py-1.5 text-sm text-white/90 hover:text-white">Book a Tour</a>
					</div>
				</div>
				<a href="/experiences" class="py-3 px-3 text-white hover:bg-white/10 rounded-lg transition-colors border-b border-white/10">Experiences</a>
				<a href="/contact" class="py-3 px-3 text-white hover:bg-white/10 rounded-lg transition-colors border-b border-white/10">Contact</a>
				<div class="py-3 px-3 text-white/80 font-medium border-b border-white/10">Profile</div>
			</nav>

			<!-- Newsletter -->
			<div class="px-6 py-4 border-t border-white/20">
				<p class="text-white font-medium mb-2">Subscribe for newsletter</p>
				<input
					type="email"
					placeholder="Enter Email Address"
					class="w-full px-4 py-2.5 rounded-lg bg-white/95 border border-white/30 text-neutral-800 placeholder-neutral-400 text-sm focus:outline-none focus:ring-2 focus:ring-white/40"
				/>
			</div>

			<!-- Footer -->
			<div class="px-6 py-4 border-t border-white/20">
				<p class="text-white/70 text-xs">Copyright © 2025 Opawey. All rights reserved.</p>
			</div>
		</aside>

		<!-- Main content -->
		<div class="flex-1 min-h-screen md:ml-72 flex items-center justify-center px-6 py-24 relative">
			<div class="fixed top-0 right-0 w-[600px] h-[600px] bg-[#0C6B95]/6 rounded-full blur-3xl -translate-y-1/3 translate-x-1/4 pointer-events-none"></div>
			<div class="fixed bottom-0 left-0 w-[400px] h-[400px] bg-sky-100/60 rounded-full blur-3xl translate-y-1/3 -translate-x-1/4 pointer-events-none md:left-72"></div>

			<div class="relative z-10 w-full max-w-md">
				<!-- Logo (optional, for context) -->
				<div class="flex justify-center mb-8">
					<a href="/" aria-label="Go to homepage">
						<img src="/logo-opawey.png" alt="Opawey" class="h-16 w-auto object-contain" />
					</a>
				</div>

				<!-- Card -->
				<div class="bg-white rounded-3xl border border-neutral-200 shadow-xl shadow-neutral-200/60 p-8 lg:p-10">
					<!-- Loading state -->
					<div id="profile-loading" class="text-center py-8 text-neutral-500 text-sm">
						Loading…
					</div>

					<!-- Profile content (hidden until user is loaded) -->
					<div id="profile-content" class="hidden">
						<div class="mb-8">
							<div class="flex items-center gap-2 mb-3">
								<span class="w-2 h-2 rounded-full bg-[#0C6B95] shrink-0"></span>
								<span class="text-xs font-medium text-[#0C6B95] tracking-widest uppercase">My Account</span>
							</div>
							<h1 class="text-3xl font-bold text-neutral-900">Profile</h1>
							<p class="text-neutral-500 text-sm mt-1">Your account details.</p>
						</div>

						<div id="profile-avatar-wrap" class="hidden">
							<div class="flex justify-center mb-6">
								<img id="profile-avatar" src="" alt="" class="w-20 h-20 rounded-full object-cover border-2 border-neutral-200" />
							</div>
						</div>

						<div class="flex flex-col gap-1.5 mb-5">
							<label class="text-neutral-700 text-xs font-medium uppercase tracking-widest">Name</label>
							<p id="profile-display-name" class="py-3 px-4 bg-neutral-50 border border-neutral-200 rounded-xl text-neutral-800 text-sm"></p>
						</div>

						<div class="flex flex-col gap-1.5 mb-8">
							<label class="text-neutral-700 text-xs font-medium uppercase tracking-widest">Email</label>
							<p id="profile-email" class="py-3 px-4 bg-neutral-50 border border-neutral-200 rounded-xl text-neutral-800 text-sm"></p>
						</div>

						<button
							type="button"
							id="profile-sign-out"
							class="w-full py-3.5 bg-neutral-900 hover:bg-neutral-800 text-white font-semibold rounded-xl transition-colors duration-200 flex items-center justify-center gap-2"
						>
							Sign out
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
							</svg>
						</button>
					</div>
				</div>
			</div>
		</div>
	</main>
</Layout>

<script>
	import { auth } from '../lib/firebase';
	import { onAuthStateChanged, signOut } from 'firebase/auth';

	const loadingEl = document.getElementById('profile-loading');
	const contentEl = document.getElementById('profile-content');
	const avatarWrap = document.getElementById('profile-avatar-wrap');
	const avatarImg = document.getElementById('profile-avatar') as HTMLImageElement | null;
	const displayNameEl = document.getElementById('profile-display-name');
	const emailEl = document.getElementById('profile-email');
	const signOutBtn = document.getElementById('profile-sign-out');
	const sidebar = document.getElementById('profile-sidebar');
	const overlay = document.getElementById('profile-sidebar-overlay');
	const burger = document.getElementById('profile-burger');

	function openSidebar() {
		sidebar?.classList.remove('-translate-x-full');
		overlay?.classList.remove('hidden');
		document.body.style.overflow = 'hidden';
	}
	function closeSidebar() {
		sidebar?.classList.add('-translate-x-full');
		overlay?.classList.add('hidden');
		document.body.style.overflow = '';
	}
	function toggleSidebar() {
		if (sidebar?.classList.contains('-translate-x-full')) openSidebar();
		else closeSidebar();
	}

	burger?.addEventListener('click', toggleSidebar);
	overlay?.addEventListener('click', closeSidebar);
	sidebar?.querySelectorAll('a').forEach((link) => link.addEventListener('click', closeSidebar));

	onAuthStateChanged(auth, (user) => {
		if (!user) {
			window.location.href = '/login';
			return;
		}
		if (loadingEl) loadingEl.classList.add('hidden');
		if (contentEl) contentEl.classList.remove('hidden');
		if (displayNameEl) displayNameEl.textContent = user.displayName?.trim() || '—';
		if (emailEl) emailEl.textContent = user.email || '—';
		if (user.photoURL && avatarWrap && avatarImg) {
			avatarImg.src = user.photoURL;
			avatarImg.alt = user.displayName || 'Profile photo';
			avatarWrap.classList.remove('hidden');
		}
	});

	signOutBtn?.addEventListener('click', async () => {
		try {
			await signOut(auth);
			window.location.href = '/';
		} catch {
			window.location.href = '/';
		}
	});
</script>
