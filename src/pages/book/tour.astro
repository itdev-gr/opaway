---
import Layout from '../../layouts/Layout.astro';
---

<Layout>
	<main class="min-h-screen bg-sky-50 pt-36 pb-24 px-6 lg:px-10">
		<div class="max-w-6xl mx-auto">

			<!-- Sub-navigation tabs -->
			<div class="flex items-center gap-3 mb-10">
				<a href="/book/transfer" class="flex items-center gap-2 px-5 py-2.5 rounded-xl bg-white border border-neutral-200 text-neutral-600 font-semibold text-sm hover:border-[#0C6B95]/40 hover:text-[#0C6B95] transition-colors">
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
					</svg>
					Book a Transfer
				</a>
				<a href="/book/tour" class="flex items-center gap-2 px-5 py-2.5 rounded-xl bg-[#0C6B95] text-white font-semibold text-sm shadow-md shadow-[#0C6B95]/25">
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
					</svg>
					Book a Tour
				</a>
			</div>

			<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-10 items-start">

				<!-- ── Booking form panel ── -->
				<div class="bg-white rounded-2xl p-6 lg:p-8 border border-neutral-200 shadow-sm">

					<h2 class="text-2xl font-bold text-neutral-900 mb-6">Tour Details</h2>

					<!-- Tour Type -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-neutral-700 mb-1">Tour Experience</label>
						<div class="relative">
							<span class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 pointer-events-none">
								<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>
							</span>
							<select id="tour-select" class="w-full pl-10 pr-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-neutral-800 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] appearance-none cursor-pointer">
								<option value="" disabled selected>Select a tour...</option>
							</select>
							<span class="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 pointer-events-none">
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
							</span>
						</div>
					</div>

					<!-- Pickup Location -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-neutral-700 mb-1">Pickup Location</label>
						<div class="relative">
							<span class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">
								<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
							</span>
							<input type="text" placeholder="Hotel, address or landmark..." class="w-full pl-10 pr-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95]" />
						</div>
					</div>

					<!-- Date & Time -->
					<div class="grid grid-cols-2 gap-4 mb-5">
						<div>
							<label class="block text-sm font-medium text-neutral-700 mb-1">Tour date</label>
							<div class="relative">
								<span class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">
									<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
								</span>
								<input type="text" placeholder="Select date" class="w-full pl-10 pr-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] cursor-pointer" />
							</div>
						</div>
						<div>
							<label class="block text-sm font-medium text-neutral-700 mb-1">Pickup time</label>
							<div class="relative">
								<span class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">
									<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
								</span>
								<input type="text" placeholder="Select time" class="w-full pl-10 pr-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] cursor-pointer" />
							</div>
						</div>
					</div>

					<!-- Participants -->
					<div class="mb-5">
						<label class="block text-sm font-medium text-neutral-700 mb-2">Participants</label>
						<div class="flex items-center gap-3">
							<div class="flex-1 flex items-center gap-2 pl-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl">
								<svg class="w-5 h-5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
								<span class="text-neutral-800 font-medium" id="participant-count">2</span>
							</div>
							<button type="button" id="pax-minus" class="w-10 h-10 flex items-center justify-center rounded-xl bg-neutral-800 text-white hover:bg-neutral-700 transition-colors text-lg font-bold" aria-label="Fewer participants">−</button>
							<button type="button" id="pax-plus" class="w-10 h-10 flex items-center justify-center rounded-xl bg-neutral-800 text-white hover:bg-neutral-700 transition-colors text-lg font-bold" aria-label="More participants">+</button>
						</div>
					</div>

					<!-- Special Requests -->
					<div class="mb-6">
						<label class="block text-sm font-medium text-neutral-700 mb-1">Special Requests <span class="text-neutral-400 font-normal">(optional)</span></label>
						<textarea
							rows="3"
							placeholder="Dietary requirements, accessibility needs, preferences..."
							class="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] resize-none"
						></textarea>
					</div>

					<!-- Request Button -->
					<button type="button" class="w-full py-4 bg-[#0C6B95] hover:bg-[#0a5c82] text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2 shadow-lg shadow-[#0C6B95]/25">
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
						Request This Tour
					</button>
				</div>

				<!-- ── Tour carousel ── -->
				<div data-tour-carousel class="flex flex-col">
					<div class="mb-5">
						<div class="flex items-center gap-2 mb-2">
							<span class="w-2 h-2 rounded-full bg-[#0C6B95] shrink-0"></span>
							<span class="text-sm font-medium text-neutral-500 tracking-widest uppercase">Our Experiences</span>
						</div>
						<h2 class="text-2xl lg:text-3xl font-bold text-neutral-900">Curated Tours in Greece</h2>
					</div>

					<!-- Cards container — filled by JS -->
					<div id="tour-carousel-inner" class="relative overflow-hidden rounded-2xl flex-1">
						<div class="bg-white border border-neutral-200 rounded-2xl overflow-hidden shadow-sm p-12 flex items-center justify-center">
							<p class="text-neutral-400 text-sm">Loading tours…</p>
						</div>
					</div>

					<div class="flex items-center justify-between mt-4">
						<button data-tour-prev class="w-10 h-10 flex items-center justify-center rounded-full border border-neutral-200 bg-white hover:bg-[#0C6B95] hover:border-[#0C6B95] hover:text-white text-neutral-600 transition-all duration-200 shadow-sm" aria-label="Previous">
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
						</button>
						<span data-tour-indicator class="text-sm font-semibold text-neutral-500">— / —</span>
						<button data-tour-next class="w-10 h-10 flex items-center justify-center rounded-full border border-neutral-200 bg-white hover:bg-[#0C6B95] hover:border-[#0C6B95] hover:text-white text-neutral-600 transition-all duration-200 shadow-sm" aria-label="Next">
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
						</button>
					</div>
				</div>

			</div>
		</div>
	</main>

	<!-- ── Published Tours Catalog ── -->
	<section id="catalog-section" class="py-20 lg:py-24 px-6 lg:px-10 bg-white hidden">
		<div class="max-w-6xl mx-auto">

			<!-- Header -->
			<div class="mb-12 text-center">
				<div class="flex items-center justify-center gap-2 mb-4">
					<span class="w-2 h-2 rounded-full bg-[#0C6B95]"></span>
					<span class="text-sm font-medium text-neutral-500 tracking-widest uppercase">Our Tours</span>
				</div>
				<h2 class="text-4xl font-bold text-neutral-900 mb-4">Explore Available Tours</h2>
				<div class="w-16 h-1 bg-[#0C6B95] rounded-full mx-auto mb-4"></div>
				<p class="text-neutral-500 text-base max-w-xl mx-auto leading-relaxed">
					Choose from our curated selection of private tours, each designed to give you an extraordinary taste of Greece.
				</p>
			</div>

			<!-- Cards grid (filled by JS) -->
			<div id="tours-catalog-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>

		</div>
	</section>

</Layout>

<script>
	// Participant counter
	const countEl = document.getElementById('participant-count');
	let count = 2;
	document.getElementById('pax-minus')?.addEventListener('click', () => {
		if (count > 1) { count--; if (countEl) countEl.textContent = String(count); }
	});
	document.getElementById('pax-plus')?.addEventListener('click', () => {
		count++; if (countEl) countEl.textContent = String(count);
	});
</script>

<script>
	import { db } from '../../lib/firebase';
	import { collection, getDocs, orderBy, query } from 'firebase/firestore';

	interface TourItem {
		title: string; description: string; price: number; imageUrl: string;
		duration: string; highlight1: string; highlight2: string; highlight3: string;
		published: boolean;
	}

	const esc = (s: string) => String(s)
		.replace(/&/g, '&amp;').replace(/</g, '&lt;')
		.replace(/>/g, '&gt;').replace(/"/g, '&quot;');

	async function loadTours() {
		try {
			const snap = await getDocs(query(collection(db, 'toursCatalog'), orderBy('createdAt', 'desc')));
			const docs = snap.docs.filter(d => d.data().published !== false);

			/* ── Carousel ──────────────────────────────────────────────── */
			const inner = document.getElementById('tour-carousel-inner')!;

			if (docs.length === 0) {
				inner.innerHTML = `
					<div class="bg-white border border-neutral-200 rounded-2xl overflow-hidden shadow-sm p-12 flex items-center justify-center">
						<p class="text-neutral-400 text-sm text-center">No tours available at the moment.<br/>Check back soon.</p>
					</div>`;
			} else {
				inner.innerHTML = docs.map((d, i) => {
					const t = d.data() as TourItem;
					const highlights = [t.highlight1, t.highlight2, t.highlight3].filter(Boolean);
					return `
					<article data-tour-card class="bg-white border border-neutral-200 rounded-2xl overflow-hidden shadow-sm flex flex-col ${i === 0 ? '' : 'hidden'}">
						<div class="aspect-[16/9] overflow-hidden">
							<img
								src="${esc(t.imageUrl)}"
								alt="${esc(t.title)}"
								class="w-full h-full object-cover"
								onerror="this.parentElement.style.background='#e5e7eb';this.style.display='none'"
							/>
						</div>
						<div class="p-6 flex flex-col">
							${t.duration ? `
							<div class="flex items-center gap-2 mb-2">
								<svg class="w-4 h-4 text-[#0C6B95] shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
									<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
								</svg>
								<span class="text-xs font-semibold text-[#0C6B95] uppercase tracking-wide">${esc(t.duration)}</span>
							</div>` : ''}
							<h3 class="text-2xl font-bold text-neutral-900 mb-2">${esc(t.title)}</h3>
							${t.description ? `<p class="text-sm text-neutral-500 mb-4 leading-relaxed">${esc(t.description)}</p>` : ''}
							${highlights.length > 0 ? `
							<div class="w-16 h-1 bg-[#0C6B95] rounded-full mb-5"></div>
							<ul class="flex flex-col gap-3">
								${highlights.map(h => `
								<li class="flex items-start gap-3">
									<svg class="w-4 h-4 text-[#0C6B95] mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
										<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
									</svg>
									<span class="text-sm text-neutral-600 leading-snug">${esc(h)}</span>
								</li>`).join('')}
							</ul>` : ''}
						</div>
					</article>`;
				}).join('');

				/* Init carousel */
				const carousel  = inner.closest('[data-tour-carousel]')!;
				const cards     = Array.from(inner.querySelectorAll<HTMLElement>('[data-tour-card]'));
				const prevBtn   = carousel.querySelector('[data-tour-prev]') as HTMLButtonElement;
				const nextBtn   = carousel.querySelector('[data-tour-next]') as HTMLButtonElement;
				const indicator = carousel.querySelector('[data-tour-indicator]') as HTMLElement;

				if (indicator) indicator.textContent = `1 / ${cards.length}`;

				if (cards.length <= 1) {
					if (prevBtn) prevBtn.classList.add('invisible');
					if (nextBtn) nextBtn.classList.add('invisible');
				} else {
					let current = 0;
					let animating = false;

					const wait = (ms: number) => new Promise<void>(r => setTimeout(r, ms));

					async function goTo(idx: number, dir: 'prev' | 'next') {
						if (animating) return;
						animating = true;
						const out = cards[current];
						const nextIdx = (idx + cards.length) % cards.length;
						const inc = cards[nextIdx];

						out.style.transition = 'transform 220ms ease, opacity 220ms ease';
						out.style.transform  = dir === 'next' ? 'translateX(-48px)' : 'translateX(48px)';
						out.style.opacity    = '0';
						await wait(220);
						out.classList.add('hidden');
						out.style.cssText = '';

						inc.style.transition = 'none';
						inc.style.transform  = dir === 'next' ? 'translateX(48px)' : 'translateX(-48px)';
						inc.style.opacity    = '0';
						inc.classList.remove('hidden');
						inc.getBoundingClientRect();
						inc.style.transition = 'transform 220ms ease, opacity 220ms ease';
						inc.style.transform  = 'translateX(0)';
						inc.style.opacity    = '1';

						current = nextIdx;
						if (indicator) indicator.textContent = `${current + 1} / ${cards.length}`;
						await wait(220);
						inc.style.cssText = '';
						animating = false;
					}

					prevBtn?.addEventListener('click', () => goTo(current - 1, 'prev'));
					nextBtn?.addEventListener('click', () => goTo(current + 1, 'next'));
				}
			}

			/* ── Select dropdown ───────────────────────────────────────── */
			const select = document.getElementById('tour-select') as HTMLSelectElement;
			if (select && docs.length > 0) {
				docs.forEach(d => {
					const t = d.data() as TourItem;
					const opt = document.createElement('option');
					opt.value = d.id;
					opt.textContent = t.title;
					select.appendChild(opt);
				});
			}

			/* ── Catalog grid ──────────────────────────────────────────── */
			if (docs.length === 0) return;

			const catalogSection = document.getElementById('catalog-section')!;
			const catalogGrid    = document.getElementById('tours-catalog-grid')!;

			catalogGrid.innerHTML = docs.map(d => {
				const t = d.data() as TourItem;
				return `
				<div class="group bg-white rounded-2xl overflow-hidden shadow-sm border border-neutral-100 hover:shadow-xl transition-shadow duration-300">
					<div class="aspect-[4/3] overflow-hidden bg-neutral-100">
						<img
							src="${esc(t.imageUrl)}"
							alt="${esc(t.title)}"
							class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
							onerror="this.parentElement.style.background='#f3f4f6';this.style.display='none'"
						/>
					</div>
					<div class="p-6">
						<h3 class="text-xl font-bold text-neutral-900 mb-2 leading-snug">${esc(t.title)}</h3>
						<p class="text-neutral-500 text-sm leading-relaxed mb-5 overflow-hidden" style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical">${esc(t.description)}</p>
						<div class="flex items-center justify-between">
							<div>
								<span class="text-xs text-neutral-400 font-medium uppercase tracking-wider">From</span>
								<p class="text-2xl font-bold text-[#0C6B95] leading-none mt-0.5">€${Number(t.price).toFixed(2)}</p>
							</div>
							<a
								href="/contact"
								class="inline-flex items-center gap-2 bg-[#0C6B95] hover:bg-[#0a5c82] text-white text-sm font-semibold px-5 py-2.5 rounded-xl transition-colors duration-200 shadow-sm shadow-[#0C6B95]/20"
							>
								Book Now
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
									<path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
								</svg>
							</a>
						</div>
					</div>
				</div>`;
			}).join('');

			catalogSection.classList.remove('hidden');

		} catch (err) {
			console.error('Tours load error:', err);
		}
	}

	loadTours();
</script>
