---
import AdminLayout from '../../components/AdminLayout.astro';
---

<AdminLayout pageTitle="Experiences Catalog" pageDescription="Add and manage experiences displayed on the website." activeSection="manage-experiences">

	<!-- Add New Experience Form -->
	<div class="bg-white rounded-2xl border border-neutral-200 shadow-sm p-6 mb-6">
		<h2 class="text-base font-semibold text-neutral-800 mb-5 flex items-center gap-2">
			<svg class="w-4 h-4 text-[#0C6B95]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
			</svg>
			Add New Experience
		</h2>

		<form id="exp-form" class="space-y-4" novalidate>

			<!-- Image URL + Live Preview -->
			<div class="flex flex-col sm:flex-row gap-4 items-start">
				<div class="flex-1">
					<label class="block text-xs font-semibold text-neutral-600 mb-1.5 uppercase tracking-wider">Image URL *</label>
					<input
						id="f-image" type="url" required
						placeholder="https://example.com/photo.jpg"
						class="w-full px-4 py-2.5 bg-white border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] shadow-sm"
					/>
					<p class="text-xs text-neutral-400 mt-1.5">Paste a direct link to the experience image (JPG, PNG, WebP)</p>
				</div>
				<div class="sm:w-48 h-32 rounded-xl overflow-hidden border border-neutral-200 bg-neutral-100 flex items-center justify-center shrink-0">
					<img id="img-preview" src="" alt="Preview" class="w-full h-full object-cover hidden" />
					<span id="img-placeholder" class="text-neutral-400 text-xs font-medium flex flex-col items-center gap-1.5">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
							<path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
						</svg>
						Preview
					</span>
				</div>
			</div>

			<!-- Title + Price -->
			<div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
				<div class="sm:col-span-2">
					<label class="block text-xs font-semibold text-neutral-600 mb-1.5 uppercase tracking-wider">Title *</label>
					<input
						id="f-title" type="text" required
						placeholder="e.g. Athens Wine Tasting Tour"
						class="w-full px-4 py-2.5 bg-white border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] shadow-sm"
					/>
				</div>
				<div>
					<label class="block text-xs font-semibold text-neutral-600 mb-1.5 uppercase tracking-wider">Price (€) *</label>
					<input
						id="f-price" type="number" min="0" step="0.01" required
						placeholder="e.g. 200"
						class="w-full px-4 py-2.5 bg-white border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] shadow-sm"
					/>
				</div>
			</div>

			<!-- Description -->
			<div>
				<label class="block text-xs font-semibold text-neutral-600 mb-1.5 uppercase tracking-wider">Description *</label>
				<textarea
					id="f-description" required rows="4"
					placeholder="Describe the experience, what's included, highlights…"
					class="w-full px-4 py-2.5 bg-white border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] shadow-sm resize-none"
				></textarea>
			</div>

			<!-- Status + Submit -->
			<div class="flex items-center justify-between pt-1">
				<span id="form-status" class="text-sm"></span>
				<button
					type="submit"
					id="submit-btn"
					class="inline-flex items-center gap-2 bg-[#0C6B95] hover:bg-[#0a5c82] text-white text-sm font-semibold px-6 py-2.5 rounded-xl transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
				>
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
						<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
					</svg>
					Add Experience
				</button>
			</div>
		</form>
	</div>

	<!-- Experiences Grid -->
	<div class="bg-white rounded-2xl border border-neutral-200 shadow-sm overflow-hidden">
		<div class="px-6 py-4 border-b border-neutral-100 flex items-center justify-between">
			<h2 class="text-base font-semibold text-neutral-800">Experiences Catalog</h2>
			<span id="exp-count" class="text-xs text-neutral-400 font-medium"></span>
		</div>
		<div id="exp-grid" class="p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
			<p class="text-neutral-400 text-sm col-span-full text-center py-10">Loading…</p>
		</div>
	</div>

	<!-- Delete confirmation modal -->
	<div id="delete-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
		<div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
			<div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
				<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
					<path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
				</svg>
			</div>
			<h3 class="text-base font-bold text-neutral-900 text-center mb-1">Delete Experience</h3>
			<p id="delete-modal-body" class="text-sm text-neutral-500 text-center mb-6">This experience will be permanently removed from the website.</p>
			<div class="flex gap-3">
				<button id="delete-no"  class="flex-1 py-2.5 rounded-xl border border-neutral-200 text-neutral-700 font-semibold text-sm hover:bg-neutral-50 transition-colors">No</button>
				<button id="delete-yes" class="flex-1 py-2.5 rounded-xl bg-red-600 hover:bg-red-700 font-semibold text-sm text-white transition-colors">Yes</button>
			</div>
		</div>
	</div>

	<!-- Edit modal -->
	<div id="edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
		<div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg">
			<div class="flex items-center justify-between mb-5">
				<h3 class="text-base font-bold text-neutral-900">Edit Experience</h3>
				<button id="edit-close" class="text-neutral-400 hover:text-neutral-600 transition-colors" type="button">
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</div>
			<div class="space-y-4">
				<!-- Edit Image URL + Preview -->
				<div class="flex flex-col sm:flex-row gap-4 items-start">
					<div class="flex-1">
						<label class="block text-xs font-semibold text-neutral-600 mb-1.5 uppercase tracking-wider">Image URL *</label>
						<input
							id="e-image" type="url"
							class="w-full px-4 py-2.5 bg-white border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] shadow-sm"
						/>
					</div>
					<div class="sm:w-36 h-24 rounded-xl overflow-hidden border border-neutral-200 bg-neutral-100 flex items-center justify-center shrink-0">
						<img id="e-img-preview" src="" alt="Preview" class="w-full h-full object-cover hidden" />
						<span id="e-img-placeholder" class="text-neutral-400 text-xs flex flex-col items-center gap-1">
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
								<path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
							</svg>
							Preview
						</span>
					</div>
				</div>
				<!-- Edit Title + Price -->
				<div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
					<div class="sm:col-span-2">
						<label class="block text-xs font-semibold text-neutral-600 mb-1.5 uppercase tracking-wider">Title *</label>
						<input
							id="e-title" type="text"
							class="w-full px-4 py-2.5 bg-white border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] shadow-sm"
						/>
					</div>
					<div>
						<label class="block text-xs font-semibold text-neutral-600 mb-1.5 uppercase tracking-wider">Price (€) *</label>
						<input
							id="e-price" type="number" min="0" step="0.01"
							class="w-full px-4 py-2.5 bg-white border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] shadow-sm"
						/>
					</div>
				</div>
				<!-- Edit Description -->
				<div>
					<label class="block text-xs font-semibold text-neutral-600 mb-1.5 uppercase tracking-wider">Description *</label>
					<textarea
						id="e-description" rows="4"
						class="w-full px-4 py-2.5 bg-white border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] shadow-sm resize-none"
					></textarea>
				</div>
				<!-- Edit status + Save -->
				<div class="flex items-center justify-between pt-1">
					<span id="edit-status" class="text-sm"></span>
					<div class="flex gap-3">
						<button id="edit-cancel" type="button" class="px-5 py-2.5 rounded-xl border border-neutral-200 text-neutral-700 font-semibold text-sm hover:bg-neutral-50 transition-colors">Cancel</button>
						<button id="edit-save"   type="button" class="inline-flex items-center gap-2 bg-[#0C6B95] hover:bg-[#0a5c82] text-white text-sm font-semibold px-6 py-2.5 rounded-xl transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">Save Changes</button>
					</div>
				</div>
			</div>
		</div>
	</div>

</AdminLayout>

<script>
	import { db } from '../../lib/firebase';
	import { collection, addDoc, getDocs, deleteDoc, updateDoc, doc, orderBy, query, serverTimestamp } from 'firebase/firestore';

	/* ── Types ── */
	interface CatalogItem { id: string; title: string; description: string; price: number; imageUrl: string; published: boolean; }

	/* ── State ── */
	let items: CatalogItem[] = [];
	let pendingDeleteId = '';
	let pendingEditId   = '';

	/* ── Escape HTML ── */
	const esc = (s: string) => String(s)
		.replace(/&/g, '&amp;').replace(/</g, '&lt;')
		.replace(/>/g, '&gt;').replace(/"/g, '&quot;');

	/* ── Add-form image preview ── */
	const imgInput       = document.getElementById('f-image')       as HTMLInputElement;
	const imgPreview     = document.getElementById('img-preview')    as HTMLImageElement;
	const imgPlaceholder = document.getElementById('img-placeholder')!;
	let previewTimer: ReturnType<typeof setTimeout>;

	function applyPreview(input: HTMLInputElement, preview: HTMLImageElement, placeholder: Element) {
		const url = input.value.trim();
		if (url) {
			preview.src = url;
			preview.classList.remove('hidden');
			placeholder.classList.add('hidden');
			preview.onerror = () => { preview.classList.add('hidden'); placeholder.classList.remove('hidden'); };
		} else {
			preview.classList.add('hidden');
			placeholder.classList.remove('hidden');
		}
	}

	imgInput.addEventListener('input', () => {
		clearTimeout(previewTimer);
		previewTimer = setTimeout(() => applyPreview(imgInput, imgPreview, imgPlaceholder), 400);
	});

	/* ── Edit-modal image preview ── */
	const eImgInput       = document.getElementById('e-image')       as HTMLInputElement;
	const eImgPreview     = document.getElementById('e-img-preview') as HTMLImageElement;
	const eImgPlaceholder = document.getElementById('e-img-placeholder')!;
	let ePreviewTimer: ReturnType<typeof setTimeout>;

	eImgInput.addEventListener('input', () => {
		clearTimeout(ePreviewTimer);
		ePreviewTimer = setTimeout(() => applyPreview(eImgInput, eImgPreview, eImgPlaceholder), 400);
	});

	/* ── Render grid ── */
	function renderGrid() {
		const grid    = document.getElementById('exp-grid')!;
		const countEl = document.getElementById('exp-count');
		if (countEl) countEl.textContent = `${items.length} experience${items.length !== 1 ? 's' : ''}`;

		if (items.length === 0) {
			grid.innerHTML = `<p class="text-neutral-400 text-sm col-span-full text-center py-12">No experiences added yet. Use the form above to publish your first experience.</p>`;
			return;
		}

		grid.innerHTML = items.map(item => {
			const isLive = item.published !== false;
			return `
			<div class="group rounded-xl border border-neutral-200 overflow-hidden bg-neutral-50 shadow-sm hover:shadow-md transition-shadow duration-200">
				<!-- Image + status badge -->
				<div class="aspect-video overflow-hidden bg-neutral-200 relative">
					<img
						src="${esc(item.imageUrl)}"
						alt="${esc(item.title)}"
						class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
						onerror="this.closest('.aspect-video').style.background='#e5e7eb'"
					/>
					<span class="absolute top-2 left-2 text-xs font-semibold px-2 py-0.5 rounded-full ${isLive ? 'bg-emerald-100 text-emerald-700' : 'bg-neutral-200 text-neutral-500'}">
						${isLive ? 'Live' : 'Hidden'}
					</span>
				</div>
				<!-- Content -->
				<div class="p-4">
					<h3 class="font-semibold text-neutral-900 mb-1 truncate text-sm">${esc(item.title)}</h3>
					<p class="text-xs text-neutral-500 leading-relaxed mb-3 overflow-hidden" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical">${esc(item.description)}</p>
					<span class="text-base font-bold text-[#0C6B95]">€${Number(item.price).toFixed(2)}</span>
					<!-- Actions -->
					<div class="flex items-center gap-2 mt-3 pt-3 border-t border-neutral-100">
						<!-- Toggle On/Off -->
						<button
							class="toggle-btn flex-1 py-1.5 rounded-lg border text-xs font-semibold transition-colors ${isLive ? 'bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100' : 'bg-neutral-100 text-neutral-500 border-neutral-200 hover:bg-neutral-200'}"
							data-id="${item.id}" data-published="${isLive}" type="button"
						>${isLive ? 'On' : 'Off'}</button>
						<!-- Edit -->
						<button
							class="edit-btn p-1.5 rounded-lg border border-neutral-200 text-neutral-400 hover:text-[#0C6B95] hover:border-[#0C6B95]/30 hover:bg-sky-50 transition-colors"
							data-id="${item.id}" type="button" title="Edit"
						>
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536M9 13l6.586-6.586a2 2 0 112.828 2.828L11.828 15.828a2 2 0 01-1.414.586H9v-2a2 2 0 01.586-1.414z" />
							</svg>
						</button>
						<!-- Delete -->
						<button
							class="delete-btn p-1.5 rounded-lg border border-neutral-200 text-neutral-400 hover:text-red-500 hover:border-red-200 hover:bg-red-50 transition-colors"
							data-id="${item.id}" data-title="${esc(item.title)}" type="button" title="Delete"
						>
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7M10 11v6m4-6v6M9 7V4h6v3M4 7h16"/>
							</svg>
						</button>
					</div>
				</div>
			</div>`;
		}).join('');

		/* Attach toggle handlers */
		document.querySelectorAll<HTMLButtonElement>('.toggle-btn').forEach(btn => {
			btn.addEventListener('click', async () => {
				const id     = btn.dataset.id!;
				const isLive = btn.dataset.published === 'true';
				btn.disabled = true;
				try {
					await updateDoc(doc(db, 'experiencesCatalog', id), { published: !isLive });
					const item = items.find(i => i.id === id);
					if (item) item.published = !isLive;
					renderGrid();
				} catch (err) { console.error(err); btn.disabled = false; }
			});
		});

		/* Attach edit handlers */
		document.querySelectorAll<HTMLButtonElement>('.edit-btn').forEach(btn => {
			btn.addEventListener('click', () => openEditModal(btn.dataset.id!));
		});

		/* Attach delete handlers */
		document.querySelectorAll<HTMLButtonElement>('.delete-btn').forEach(btn => {
			btn.addEventListener('click', () => {
				pendingDeleteId = btn.dataset.id!;
				const modal = document.getElementById('delete-modal')!;
				const body  = document.getElementById('delete-modal-body')!;
				body.textContent = `"${btn.dataset.title}" will be permanently removed from the website.`;
				modal.classList.remove('hidden');
				modal.classList.add('flex');
			});
		});
	}

	/* ── Load from Firestore ── */
	async function loadItems() {
		const grid = document.getElementById('exp-grid')!;
		try {
			const snap = await getDocs(query(collection(db, 'experiencesCatalog'), orderBy('createdAt', 'desc')));
			items = snap.docs.map(d => ({ id: d.id, ...(d.data() as Omit<CatalogItem, 'id'>) }));
			renderGrid();
		} catch (e) {
			console.error('Load error:', e);
			grid.innerHTML = `<p class="text-neutral-400 text-sm col-span-full text-center py-10">Could not load experiences.</p>`;
		}
	}

	/* ── Form submit ── */
	const form      = document.getElementById('exp-form')    as HTMLFormElement;
	const statusEl  = document.getElementById('form-status')!;
	const submitBtn = document.getElementById('submit-btn')  as HTMLButtonElement;

	const setStatus = (msg: string, cls: string) => { statusEl.textContent = msg; statusEl.className = `text-sm ${cls}`; };

	form.addEventListener('submit', async (e) => {
		e.preventDefault();
		const imageUrl    = (document.getElementById('f-image')       as HTMLInputElement).value.trim();
		const title       = (document.getElementById('f-title')       as HTMLInputElement).value.trim();
		const description = (document.getElementById('f-description') as HTMLTextAreaElement).value.trim();
		const price       = parseFloat((document.getElementById('f-price') as HTMLInputElement).value);

		if (!imageUrl || !title || !description || isNaN(price)) {
			setStatus('Please fill in all fields.', 'text-red-500'); return;
		}

		submitBtn.disabled = true;
		submitBtn.textContent = 'Adding…';
		setStatus('', '');

		try {
			const docRef = await addDoc(collection(db, 'experiencesCatalog'), {
				imageUrl, title, description, price, published: true, createdAt: serverTimestamp(),
			});
			items.unshift({ id: docRef.id, imageUrl, title, description, price, published: true });
			renderGrid();
			form.reset();
			imgPreview.classList.add('hidden');
			imgPlaceholder.classList.remove('hidden');
			setStatus('✓ Experience published successfully!', 'text-emerald-600 font-medium');
			setTimeout(() => setStatus('', ''), 4000);
		} catch (err) {
			console.error(err);
			setStatus('Error adding experience. Please try again.', 'text-red-500');
		} finally {
			submitBtn.disabled = false;
			submitBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg> Add Experience`;
		}
	});

	/* ── Delete modal ── */
	const closeDeleteModal = () => {
		const m = document.getElementById('delete-modal')!;
		m.classList.add('hidden'); m.classList.remove('flex');
	};

	document.getElementById('delete-no')?.addEventListener('click', closeDeleteModal);
	document.getElementById('delete-modal')?.addEventListener('click', (e) => { if (e.target === e.currentTarget) closeDeleteModal(); });

	document.getElementById('delete-yes')?.addEventListener('click', async () => {
		const yesBtn = document.getElementById('delete-yes') as HTMLButtonElement;
		yesBtn.textContent = 'Deleting…'; yesBtn.disabled = true;
		try {
			await deleteDoc(doc(db, 'experiencesCatalog', pendingDeleteId));
			items = items.filter(i => i.id !== pendingDeleteId);
			renderGrid();
		} catch (err) { console.error(err); }
		yesBtn.textContent = 'Yes'; yesBtn.disabled = false;
		closeDeleteModal();
	});

	/* ── Edit modal ── */
	function openEditModal(id: string) {
		const item = items.find(i => i.id === id);
		if (!item) return;
		pendingEditId = id;

		(document.getElementById('e-image')       as HTMLInputElement).value    = item.imageUrl;
		(document.getElementById('e-title')       as HTMLInputElement).value    = item.title;
		(document.getElementById('e-price')       as HTMLInputElement).value    = String(item.price);
		(document.getElementById('e-description') as HTMLTextAreaElement).value = item.description;

		applyPreview(eImgInput, eImgPreview, eImgPlaceholder);

		document.getElementById('edit-status')!.textContent = '';

		const modal = document.getElementById('edit-modal')!;
		modal.classList.remove('hidden');
		modal.classList.add('flex');
	}

	const closeEditModal = () => {
		const m = document.getElementById('edit-modal')!;
		m.classList.add('hidden'); m.classList.remove('flex');
	};

	document.getElementById('edit-close')?.addEventListener('click', closeEditModal);
	document.getElementById('edit-cancel')?.addEventListener('click', closeEditModal);
	document.getElementById('edit-modal')?.addEventListener('click', (e) => { if (e.target === e.currentTarget) closeEditModal(); });

	document.getElementById('edit-save')?.addEventListener('click', async () => {
		const imageUrl    = (document.getElementById('e-image')       as HTMLInputElement).value.trim();
		const title       = (document.getElementById('e-title')       as HTMLInputElement).value.trim();
		const description = (document.getElementById('e-description') as HTMLTextAreaElement).value.trim();
		const price       = parseFloat((document.getElementById('e-price') as HTMLInputElement).value);
		const editStatus  = document.getElementById('edit-status')!;
		const saveBtn     = document.getElementById('edit-save') as HTMLButtonElement;

		if (!imageUrl || !title || !description || isNaN(price)) {
			editStatus.textContent = 'Please fill in all fields.';
			editStatus.className = 'text-sm text-red-500';
			return;
		}

		saveBtn.disabled = true;
		saveBtn.textContent = 'Saving…';
		editStatus.textContent = '';

		try {
			await updateDoc(doc(db, 'experiencesCatalog', pendingEditId), { imageUrl, title, description, price });
			const item = items.find(i => i.id === pendingEditId);
			if (item) Object.assign(item, { imageUrl, title, description, price });
			renderGrid();
			closeEditModal();
		} catch (err) {
			console.error(err);
			editStatus.textContent = 'Error saving changes. Please try again.';
			editStatus.className = 'text-sm text-red-500';
		} finally {
			saveBtn.disabled = false;
			saveBtn.textContent = 'Save Changes';
		}
	});

	/* ── Auth guard observer ── */
	const authEl   = document.getElementById('admin-auth-check');
	const observer = new MutationObserver(() => {
		if (authEl?.classList.contains('hidden')) { observer.disconnect(); loadItems(); }
	});
	if (authEl) observer.observe(authEl, { attributes: true, attributeFilter: ['class'] });
</script>
