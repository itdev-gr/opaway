---
import AdminLayout from '../../components/AdminLayout.astro';
---

<AdminLayout pageTitle="Transfers" pageDescription="All transfer bookings." activeSection="transfers">

	<div class="bg-white rounded-2xl border border-neutral-200 shadow-sm overflow-hidden">
		<div class="px-6 py-4 border-b border-neutral-100 flex items-center justify-between gap-4">
			<div class="flex items-center gap-3">
				<h2 class="text-base font-semibold text-neutral-800">All Transfers</h2>
				<span id="transfers-count" class="text-xs text-neutral-400 font-medium"></span>
			</div>
			<button id="add-transfer-btn" type="button"
				class="flex items-center gap-2 px-4 py-2 bg-[#0C6B95] hover:bg-[#0a5c82] text-white text-sm font-semibold rounded-xl transition-colors shadow-sm shadow-[#0C6B95]/20">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
					<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
				</svg>
				Add Booking
			</button>
		</div>
		<div class="overflow-x-auto">
			<table class="w-full text-sm">
				<thead>
					<tr class="bg-neutral-50 text-left">
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Date</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Name</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Email</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">From</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">To</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Passengers</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Vehicle</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Status</th>
					</tr>
				</thead>
				<tbody id="transfers-tbody">
					<tr><td colspan="8" class="px-6 py-10 text-center text-neutral-400">Loading…</td></tr>
				</tbody>
			</table>
		</div>
	</div>

	<!-- Add Booking Modal -->
	<div id="add-transfer-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/40 backdrop-blur-sm px-4 py-6">
		<div class="bg-white rounded-2xl shadow-2xl border border-neutral-200 w-full max-w-lg max-h-[90vh] overflow-y-auto">

			<div class="flex items-center justify-between px-6 py-4 border-b border-neutral-100">
				<h3 class="text-lg font-bold text-neutral-900">Add Transfer Booking</h3>
				<button id="add-transfer-close" type="button" class="p-1.5 rounded-lg hover:bg-neutral-100 text-neutral-400 transition-colors">
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
				</button>
			</div>

			<form id="add-transfer-form" class="px-6 py-5 flex flex-col gap-4">

				<div class="grid grid-cols-2 gap-4">
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Full Name *</label>
						<input id="tf-name" type="text" placeholder="John Smith" required
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
					</div>
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Email *</label>
						<input id="tf-email" type="email" placeholder="john@example.com" required
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
					</div>
				</div>

				<div class="flex flex-col gap-1.5">
					<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Phone</label>
					<input id="tf-phone" type="text" placeholder="+30 69..."
						class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
				</div>

				<div class="grid grid-cols-2 gap-4">
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">From *</label>
						<input id="tf-from" type="text" placeholder="Pickup location" required
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
					</div>
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">To *</label>
						<input id="tf-to" type="text" placeholder="Drop-off location" required
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
					</div>
				</div>

				<div class="grid grid-cols-2 gap-4">
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Date *</label>
						<input id="tf-date" type="date" required
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
					</div>
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Time</label>
						<input id="tf-time" type="time"
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
					</div>
				</div>

				<div class="grid grid-cols-2 gap-4">
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Passengers *</label>
						<input id="tf-passengers" type="number" min="1" max="60" placeholder="1" required
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
					</div>
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Vehicle</label>
						<select id="tf-vehicle"
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50">
							<option value="">Select vehicle</option>
							<option>Sedan</option>
							<option>SUV</option>
							<option>Van</option>
							<option>Minibus</option>
							<option>Bus</option>
						</select>
					</div>
				</div>

				<div class="flex flex-col gap-1.5">
					<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Notes</label>
					<textarea id="tf-notes" rows="2" placeholder="Special requests or notes..."
						class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50 resize-none"></textarea>
				</div>

				<div class="flex flex-col gap-1.5">
					<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Status</label>
					<select id="tf-status"
						class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50">
						<option value="new">New</option>
						<option value="pending">Pending</option>
						<option value="payed">Payed</option>
						<option value="planning">Planning</option>
						<option value="cancelled">Cancelled</option>
						<option value="done">Done</option>
					</select>
				</div>

				<p id="tf-error" class="hidden text-sm text-red-600"></p>

				<div class="flex gap-3 pt-1">
					<button type="button" id="add-transfer-cancel2"
						class="flex-1 py-2.5 rounded-xl border border-neutral-200 text-neutral-700 text-sm font-semibold hover:bg-neutral-50 transition-colors">Cancel</button>
					<button type="submit" id="tf-submit"
						class="flex-1 py-2.5 rounded-xl bg-[#0C6B95] hover:bg-[#0a5c82] text-white text-sm font-semibold transition-colors disabled:opacity-60">
						Save Booking
					</button>
				</div>

			</form>
		</div>
	</div>

</AdminLayout>

<script>
	import { db } from '../../lib/firebase';
	import { collection, getDocs, addDoc, updateDoc, doc, orderBy, query, serverTimestamp } from 'firebase/firestore';

	/* ── Status colours ── */
	const STATUS_COLORS: Record<string, string> = {
		new:       'bg-sky-50 text-sky-700 border-sky-200',
		pending:   'bg-amber-50 text-amber-700 border-amber-200',
		payed:     'bg-emerald-50 text-emerald-700 border-emerald-200',
		planning:  'bg-violet-50 text-violet-700 border-violet-200',
		cancelled: 'bg-red-50 text-red-600 border-red-200',
		done:      'bg-neutral-100 text-neutral-600 border-neutral-300',
	};

	const STATUS_OPTIONS = ['new', 'pending', 'payed', 'planning', 'cancelled', 'done'];

	const applySelectColor = (sel: HTMLSelectElement) => {
		const cls = STATUS_COLORS[sel.value] ?? 'bg-neutral-50 text-neutral-600 border-neutral-200';
		sel.className = `status-select appearance-none text-xs font-medium border rounded-full px-2.5 py-0.5 focus:outline-none cursor-pointer capitalize ${cls}`;
	};

	const buildStatusSelect = (docId: string, current: string) => {
		const val = current?.toLowerCase() ?? 'new';
		const opts = STATUS_OPTIONS.map(s =>
			`<option value="${s}" ${val === s ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`
		).join('');
		return `<select class="status-select" data-id="${docId}" data-col="transfers">${opts}</select>`;
	};

	async function loadTransfers() {
		const tbody = document.getElementById('transfers-tbody')!;
		const countEl = document.getElementById('transfers-count');
		try {
			const snap = await getDocs(query(collection(db, 'transfers'), orderBy('createdAt', 'desc')));
			if (countEl) countEl.textContent = `${snap.size} record${snap.size !== 1 ? 's' : ''}`;
			if (snap.empty) {
				tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-10 text-center text-neutral-400">No transfers found.</td></tr>`;
				return;
			}
			tbody.innerHTML = snap.docs.map(document => {
				const d = document.data() as Record<string, unknown>;
				const date = d.createdAt ? new Date((d.createdAt as { toDate?: () => Date }).toDate?.() ?? 0).toLocaleDateString() : '—';
				return `<tr class="border-t border-neutral-100 hover:bg-neutral-50 transition-colors">
					<td class="px-6 py-3 text-neutral-600 whitespace-nowrap">${date}</td>
					<td class="px-6 py-3 font-medium text-neutral-900 whitespace-nowrap">${d.name ?? '—'}</td>
					<td class="px-6 py-3 text-neutral-500 whitespace-nowrap">${d.email ?? '—'}</td>
					<td class="px-6 py-3 text-neutral-600">${d.from ?? '—'}</td>
					<td class="px-6 py-3 text-neutral-600">${d.to ?? '—'}</td>
					<td class="px-6 py-3 text-neutral-600 text-center">${d.passengers ?? '—'}</td>
					<td class="px-6 py-3 text-neutral-600 whitespace-nowrap">${d.vehicle ?? '—'}</td>
					<td class="px-6 py-3">${buildStatusSelect(document.id, String(d.status ?? 'new'))}</td>
				</tr>`;
			}).join('');

			/* Apply colours to all selects */
			document.querySelectorAll<HTMLSelectElement>('.status-select').forEach(applySelectColor);
		} catch {
			tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-10 text-center text-neutral-400">Could not load data.</td></tr>`;
		}
	}

	/* ── Status change delegation ── */
	document.getElementById('transfers-tbody')?.addEventListener('change', async (e) => {
		const sel = e.target as HTMLSelectElement;
		if (!sel.classList.contains('status-select')) return;
		const docId = sel.dataset.id!;
		const newStatus = sel.value;
		applySelectColor(sel);
		try {
			await updateDoc(doc(db, 'transfers', docId), { status: newStatus });
		} catch (err) {
			console.error('Failed to update status:', err);
		}
	});

	/* ── Modal ── */
	const modal      = document.getElementById('add-transfer-modal')!;
	const openModal  = () => modal.classList.remove('hidden');
	const closeModal = () => { modal.classList.add('hidden'); (document.getElementById('add-transfer-form') as HTMLFormElement)?.reset(); document.getElementById('tf-error')!.classList.add('hidden'); };

	document.getElementById('add-transfer-btn')?.addEventListener('click', openModal);
	document.getElementById('add-transfer-close')?.addEventListener('click', closeModal);
	document.getElementById('add-transfer-cancel2')?.addEventListener('click', closeModal);
	modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

	document.getElementById('add-transfer-form')?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const errorEl = document.getElementById('tf-error')!;
		const submitBtn = document.getElementById('tf-submit') as HTMLButtonElement;
		errorEl.classList.add('hidden');

		const val = (id: string) => (document.getElementById(id) as HTMLInputElement)?.value.trim();

		const name       = val('tf-name');
		const email      = val('tf-email');
		const phone      = val('tf-phone');
		const from       = val('tf-from');
		const to         = val('tf-to');
		const date       = val('tf-date');
		const time       = val('tf-time');
		const passengers = parseInt(val('tf-passengers') || '1', 10);
		const vehicle    = val('tf-vehicle');
		const notes      = val('tf-notes');
		const status     = val('tf-status') || 'new';

		if (!name || !email || !from || !to || !date || !passengers) {
			errorEl.textContent = 'Please fill in all required fields.';
			errorEl.classList.remove('hidden');
			return;
		}

		submitBtn.disabled = true;
		submitBtn.textContent = 'Saving…';
		try {
			await addDoc(collection(db, 'transfers'), {
				name, email, phone: phone || '', from, to, date,
				time: time || '', passengers, vehicle: vehicle || '',
				notes: notes || '', status,
				createdAt: serverTimestamp(),
				addedByAdmin: true,
			});
			closeModal();
			await loadTransfers();
		} catch (err) {
			console.error(err);
			errorEl.textContent = 'Failed to save. Please try again.';
			errorEl.classList.remove('hidden');
		} finally {
			submitBtn.disabled = false;
			submitBtn.textContent = 'Save Booking';
		}
	});

	/* ── Auth guard ── */
	const authEl = document.getElementById('admin-auth-check');
	const observer = new MutationObserver(() => {
		if (authEl?.classList.contains('hidden')) { observer.disconnect(); loadTransfers(); }
	});
	if (authEl) observer.observe(authEl, { attributes: true, attributeFilter: ['class'] });
</script>
