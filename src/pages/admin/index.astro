---
import AdminLayout from '../../components/AdminLayout.astro';
---

<AdminLayout pageTitle="Admin Dashboard" pageDescription="Overview of all activity." activeSection="dashboard" docTitle="Admin Dashboard — Opawey">

	<!-- Stat cards -->
	<div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-5 mb-8">

		<a href="/admin/transfers" class="bg-white rounded-2xl border border-neutral-200 shadow-sm p-6 flex flex-col gap-2 hover:border-[#0C6B95]/40 hover:shadow-md transition-all group">
			<p class="text-xs font-semibold tracking-widest uppercase text-neutral-400 group-hover:text-[#0C6B95] transition-colors">Total Bookings</p>
			<p class="text-3xl font-bold text-neutral-900" id="stat-total">—</p>
		</a>

		<a href="/admin/transfers" class="bg-white rounded-2xl border border-neutral-200 shadow-sm p-6 flex flex-col gap-2 hover:border-[#0C6B95]/40 hover:shadow-md transition-all group">
			<p class="text-xs font-semibold tracking-widest uppercase text-neutral-400 group-hover:text-[#0C6B95] transition-colors">Transfers</p>
			<p class="text-3xl font-bold text-neutral-900" id="stat-transfers">—</p>
		</a>

		<a href="/admin/tours" class="bg-white rounded-2xl border border-neutral-200 shadow-sm p-6 flex flex-col gap-2 hover:border-[#0C6B95]/40 hover:shadow-md transition-all group">
			<p class="text-xs font-semibold tracking-widest uppercase text-neutral-400 group-hover:text-[#0C6B95] transition-colors">Tours</p>
			<p class="text-3xl font-bold text-neutral-900" id="stat-tours">—</p>
		</a>

		<a href="/admin/experiences" class="bg-white rounded-2xl border border-neutral-200 shadow-sm p-6 flex flex-col gap-2 hover:border-[#0C6B95]/40 hover:shadow-md transition-all group">
			<p class="text-xs font-semibold tracking-widest uppercase text-neutral-400 group-hover:text-[#0C6B95] transition-colors">Experiences</p>
			<p class="text-3xl font-bold text-neutral-900" id="stat-experiences">—</p>
		</a>

		<a href="/admin/users" class="bg-white rounded-2xl border border-neutral-200 shadow-sm p-6 flex flex-col gap-2 hover:border-[#0C6B95]/40 hover:shadow-md transition-all group">
			<p class="text-xs font-semibold tracking-widest uppercase text-neutral-400 group-hover:text-[#0C6B95] transition-colors">Users</p>
			<p class="text-3xl font-bold text-neutral-900" id="stat-users">—</p>
		</a>

	</div>

	<!-- Recent Activity -->
	<div class="bg-white rounded-2xl border border-neutral-200 shadow-sm overflow-hidden">
		<div class="px-6 py-4 border-b border-neutral-100 flex items-center justify-between">
			<h2 class="text-base font-semibold text-neutral-800">Recent Bookings</h2>
		</div>
		<div id="recent-table-wrap" class="overflow-x-auto">
			<table class="w-full text-sm">
				<thead>
					<tr class="bg-neutral-50 text-left">
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Date</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Name</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Email</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Type</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Status</th>
					</tr>
				</thead>
				<tbody id="recent-tbody">
					<tr>
						<td colspan="5" class="px-6 py-10 text-center text-neutral-400 text-sm">Loading…</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

</AdminLayout>

<script>
	import { db } from '../../lib/firebase';
	import { collection, getDocs, query, orderBy, limit } from 'firebase/firestore';

	async function loadStats() {
		try {
			const [transfersSnap, toursSnap, experiencesSnap, usersSnap] = await Promise.all([
				getDocs(collection(db, 'transfers')),
				getDocs(collection(db, 'tours')),
				getDocs(collection(db, 'experiences')),
				getDocs(collection(db, 'users')),
			]);

			const tCount = transfersSnap.size;
			const toCount = toursSnap.size;
			const exCount = experiencesSnap.size;
			const uCount  = usersSnap.size;

			const setEl = (id: string, val: string | number) => {
				const el = document.getElementById(id);
				if (el) el.textContent = String(val);
			};
			setEl('stat-total',       tCount + toCount + exCount);
			setEl('stat-transfers',   tCount);
			setEl('stat-tours',       toCount);
			setEl('stat-experiences', exCount);
			setEl('stat-users',       uCount);

			// Recent bookings: merge all, sort by createdAt desc, show latest 10
			type Row = { date: string; name: string; email: string; type: string; status: string };
			const rows: Row[] = [];

			const toRow = (d: Record<string, unknown>, type: string): Row => ({
				date:   d.createdAt ? new Date((d.createdAt as { toDate?: () => Date }).toDate?.() ?? 0).toLocaleDateString() : '—',
				name:   (d.name  as string) || (d.displayName as string) || '—',
				email:  (d.email as string) || '—',
				type,
				status: (d.status as string) || 'pending',
			});

			transfersSnap.forEach(doc   => rows.push(toRow(doc.data() as Record<string, unknown>, 'Transfer')));
			toursSnap.forEach(doc       => rows.push(toRow(doc.data() as Record<string, unknown>, 'Tour')));
			experiencesSnap.forEach(doc => rows.push(toRow(doc.data() as Record<string, unknown>, 'Experience')));

			rows.sort((a, b) => (a.date < b.date ? 1 : -1));
			const latest = rows.slice(0, 10);

			const tbody = document.getElementById('recent-tbody');
			if (!tbody) return;

			if (latest.length === 0) {
				tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-neutral-400 text-sm">No bookings yet.</td></tr>`;
				return;
			}

			const statusBadge = (s: string) => {
				const map: Record<string, string> = {
					pending:   'bg-amber-50 text-amber-700 border-amber-200',
					confirmed: 'bg-emerald-50 text-emerald-700 border-emerald-200',
					cancelled: 'bg-red-50 text-red-600 border-red-200',
					completed: 'bg-sky-50 text-sky-700 border-sky-200',
				};
				const cls = map[s.toLowerCase()] ?? 'bg-neutral-50 text-neutral-600 border-neutral-200';
				return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${cls} capitalize">${s}</span>`;
			};

			tbody.innerHTML = latest.map(r => `
				<tr class="border-t border-neutral-100 hover:bg-neutral-50 transition-colors">
					<td class="px-6 py-3 text-neutral-600 whitespace-nowrap">${r.date}</td>
					<td class="px-6 py-3 font-medium text-neutral-900 whitespace-nowrap">${r.name}</td>
					<td class="px-6 py-3 text-neutral-500 whitespace-nowrap">${r.email}</td>
					<td class="px-6 py-3 text-neutral-600 whitespace-nowrap">${r.type}</td>
					<td class="px-6 py-3">${statusBadge(r.status)}</td>
				</tr>
			`).join('');

		} catch (e) {
			console.warn('Stats load error:', e);
			['stat-total','stat-transfers','stat-tours','stat-experiences','stat-users']
				.forEach(id => { const el = document.getElementById(id); if (el) el.textContent = '—'; });
			const tbody = document.getElementById('recent-tbody');
			if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-neutral-400 text-sm">Could not load data.</td></tr>`;
		}
	}

	// Run only after auth guard has cleared
	const authEl = document.getElementById('admin-auth-check');
	const observer = new MutationObserver(() => {
		if (authEl?.classList.contains('hidden')) {
			observer.disconnect();
			loadStats();
		}
	});
	if (authEl) observer.observe(authEl, { attributes: true, attributeFilter: ['class'] });
</script>
