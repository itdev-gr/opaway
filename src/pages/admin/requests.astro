---
import AdminLayout from '../../components/AdminLayout.astro';
---

<AdminLayout
	pageTitle="Requests"
	pageDescription="Incoming tour booking and contact form submissions."
	activeSection="requests"
	docTitle="Requests — Opawey Admin"
>

	<!-- Stats bar -->
	<div class="flex flex-wrap items-center gap-4 mb-6">
		<div class="flex items-center gap-2 bg-white border border-neutral-200 rounded-xl px-5 py-3 shadow-sm">
			<span class="text-xs font-semibold tracking-widest uppercase text-neutral-400">Total</span>
			<span id="req-count-total" class="text-2xl font-bold text-neutral-900">—</span>
		</div>
		<div class="flex items-center gap-2 bg-white border border-amber-200 rounded-xl px-5 py-3 shadow-sm">
			<span class="w-2 h-2 rounded-full bg-amber-400 shrink-0 animate-pulse"></span>
			<span class="text-xs font-semibold tracking-widest uppercase text-amber-600">New</span>
			<span id="req-count-new" class="text-2xl font-bold text-amber-600">—</span>
		</div>
		<div class="ml-auto flex items-center gap-2">
			<label class="text-xs font-medium text-neutral-500 uppercase tracking-widest">Filter:</label>
			<select id="req-filter" class="text-sm border border-neutral-200 rounded-lg px-3 py-2 bg-white text-neutral-700 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95]">
				<option value="all">All</option>
				<option value="new">New</option>
				<option value="read">Read</option>
				<option value="resolved">Resolved</option>
				<option value="tour">Tour Bookings</option>
				<option value="contact">Contact Messages</option>
			</select>
		</div>
	</div>

	<!-- Cards grid -->
	<div id="req-grid" class="grid grid-cols-1 xl:grid-cols-2 gap-5">
		<div class="col-span-full flex items-center justify-center py-16 text-neutral-400 text-sm">Loading…</div>
	</div>

	<!-- Delete confirm modal -->
	<div id="req-delete-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/40 backdrop-blur-sm px-4">
		<div class="bg-white rounded-2xl shadow-2xl border border-neutral-200 w-full max-w-sm p-6">
			<h3 class="text-lg font-bold text-neutral-900 mb-2">Delete Request</h3>
			<p class="text-sm text-neutral-500 mb-6">Are you sure you want to permanently delete this request? This cannot be undone.</p>
			<div class="flex gap-3">
				<button id="req-delete-cancel" type="button" class="flex-1 py-2.5 rounded-xl border border-neutral-200 text-neutral-700 text-sm font-semibold hover:bg-neutral-50 transition-colors">Cancel</button>
				<button id="req-delete-confirm" type="button" class="flex-1 py-2.5 rounded-xl bg-red-600 hover:bg-red-700 text-white text-sm font-semibold transition-colors">Delete</button>
			</div>
		</div>
	</div>

</AdminLayout>

<script>
	import { db } from '../../lib/firebase';
	import { collection, getDocs, doc, updateDoc, deleteDoc, orderBy, query } from 'firebase/firestore';

	interface Request {
		id: string;
		source: 'tour' | 'contact';
		status: 'new' | 'read' | 'resolved';
		createdAt: { toDate?: () => Date } | null;
		// Submitted-by (logged-in user info, null if guest)
		userId?: string | null;
		userDisplayName?: string | null;
		userEmail?: string | null;
		// Tour booking fields
		tourName?: string;
		name?: string;
		contactInfo?: string;
		pickupLocation?: string;
		date?: string;
		time?: string;
		participants?: number;
		specialRequests?: string;
		// Contact form fields
		email?: string;
		subject?: string;
		message?: string;
	}

	const esc = (s: unknown) => String(s ?? '')
		.replace(/&/g, '&amp;').replace(/</g, '&lt;')
		.replace(/>/g, '&gt;').replace(/"/g, '&quot;');

	let allRequests: Request[] = [];
	let deleteTargetId: string | null = null;

	/* ── Helpers ─────────────────────────────────────────────────── */
	const fmtDate = (r: Request) => {
		if (!r.createdAt?.toDate) return '—';
		const d = r.createdAt.toDate!();
		return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
	};

	const statusBadge = (s: string) => {
		const map: Record<string, string> = {
			new:      'bg-amber-50 text-amber-700 border-amber-200',
			read:     'bg-sky-50 text-sky-700 border-sky-200',
			resolved: 'bg-emerald-50 text-emerald-700 border-emerald-200',
		};
		const cls = map[s] ?? 'bg-neutral-50 text-neutral-600 border-neutral-200';
		return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold border ${cls} capitalize">${esc(s)}</span>`;
	};

	const sourceBadge = (src: string) => {
		if (src === 'tour') {
			return `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-[#0C6B95]/10 text-[#0C6B95] text-xs font-semibold">
				<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
					<path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
				</svg>
				Tour Booking
			</span>`;
		}
		return `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-violet-50 text-violet-700 text-xs font-semibold">
			<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
				<path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
			</svg>
			Contact Us
		</span>`;
	};

	/** Renders a label-value detail row; returns empty string if value is falsy */
	const row = (label: string, value: unknown) => value
		? `<div class="flex gap-2 text-sm">
			<span class="text-neutral-400 font-medium min-w-[120px] shrink-0">${esc(label)}</span>
			<span class="text-neutral-800 break-words">${esc(value)}</span>
		  </div>`
		: '';

	/** "Submitted by" banner — shows user account or guest pill */
	const submittedByBanner = (r: Request) => {
		const initial = (r.userDisplayName || r.userEmail || '?')[0].toUpperCase();

		if (r.userId) {
			// Registered user submitted the form
			return `
			<div class="flex items-center gap-2.5 px-5 py-3 bg-[#0C6B95]/5 border-b border-[#0C6B95]/10">
				<div class="w-8 h-8 rounded-full bg-[#0C6B95] text-white flex items-center justify-center text-xs font-bold shrink-0">${esc(initial)}</div>
				<div class="flex flex-col min-w-0">
					<div class="flex items-center gap-2">
						<span class="text-sm font-semibold text-neutral-900 truncate">${esc(r.userDisplayName || 'Registered User')}</span>
						<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-[#0C6B95]/10 text-[#0C6B95] text-[10px] font-semibold shrink-0">
							<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
								<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
							</svg>
							Registered
						</span>
					</div>
					<span class="text-xs text-neutral-500 truncate">${esc(r.userEmail || '')}</span>
				</div>
			</div>`;
		}

		// Guest (not logged in)
		return `
		<div class="flex items-center gap-2.5 px-5 py-3 bg-neutral-50 border-b border-neutral-100">
			<div class="w-8 h-8 rounded-full bg-neutral-200 text-neutral-500 flex items-center justify-center shrink-0">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
					<path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
				</svg>
			</div>
			<span class="text-sm text-neutral-500 font-medium">Guest — not logged in</span>
		</div>`;
	};

	/* ── Render ──────────────────────────────────────────────────── */
	function renderGrid(filter = 'all') {
		const grid = document.getElementById('req-grid')!;
		const newCountEl   = document.getElementById('req-count-new');
		const totalCountEl = document.getElementById('req-count-total');

		const newCount = allRequests.filter(r => r.status === 'new').length;
		if (newCountEl)   newCountEl.textContent  = String(newCount);
		if (totalCountEl) totalCountEl.textContent = String(allRequests.length);

		let filtered = allRequests;
		if      (filter === 'tour')     filtered = allRequests.filter(r => r.source === 'tour');
		else if (filter === 'contact')  filtered = allRequests.filter(r => r.source === 'contact');
		else if (filter === 'new')      filtered = allRequests.filter(r => r.status === 'new');
		else if (filter === 'read')     filtered = allRequests.filter(r => r.status === 'read');
		else if (filter === 'resolved') filtered = allRequests.filter(r => r.status === 'resolved');

		if (filtered.length === 0) {
			grid.innerHTML = `<div class="col-span-full flex items-center justify-center py-16 text-neutral-400 text-sm">No requests found.</div>`;
			return;
		}

		grid.innerHTML = filtered.map(r => {
			const isTour = r.source === 'tour';
			const isNew  = r.status === 'new';

			const detailRows = isTour
				? [
					row('Tour',         r.tourName),
					row('Name',         r.name),
					row('Contact',      r.contactInfo),
					row('Pickup',       r.pickupLocation),
					row('Date',         r.date),
					row('Time',         r.time),
					row('Participants', r.participants),
					row('Notes',        r.specialRequests),
				  ].filter(Boolean).join('')
				: [
					row('Name',    r.name),
					row('Email',   r.email),
					row('Subject', r.subject),
					row('Message', r.message),
				  ].filter(Boolean).join('');

			const accentBorder = isTour ? 'border-l-[#0C6B95]/40' : 'border-l-violet-300';

			return `
			<div class="bg-white border border-neutral-200 border-l-4 ${accentBorder} rounded-2xl shadow-sm overflow-hidden flex flex-col" data-req-id="${esc(r.id)}">

				<!-- Card header: source + status + date -->
				<div class="px-5 py-4 flex items-start justify-between gap-3 border-b border-neutral-100">
					<div class="flex flex-wrap items-center gap-2">
						${sourceBadge(r.source)}
						${isNew ? `<span class="w-2 h-2 rounded-full bg-amber-400 animate-pulse" title="New"></span>` : ''}
					</div>
					<div class="flex items-center gap-2 shrink-0">
						${statusBadge(r.status)}
						<span class="text-xs text-neutral-400 whitespace-nowrap">${fmtDate(r)}</span>
					</div>
				</div>

				<!-- Submitted by -->
				${submittedByBanner(r)}

				<!-- Request details -->
				<div class="px-5 py-4 flex flex-col gap-2.5 flex-1">
					${detailRows}
				</div>

				<!-- Actions -->
				<div class="px-5 py-3 border-t border-neutral-100 flex items-center gap-2 bg-neutral-50/60">
					${r.status !== 'read'     ? `<button class="req-action-btn flex-1 py-1.5 px-3 rounded-lg border border-sky-200 bg-sky-50 text-sky-700 text-xs font-semibold hover:bg-sky-100 transition-colors" data-id="${esc(r.id)}" data-action="read">Mark as Read</button>` : ''}
					${r.status !== 'resolved' ? `<button class="req-action-btn flex-1 py-1.5 px-3 rounded-lg border border-emerald-200 bg-emerald-50 text-emerald-700 text-xs font-semibold hover:bg-emerald-100 transition-colors" data-id="${esc(r.id)}" data-action="resolved">Mark as Resolved</button>` : ''}
					<button class="req-delete-btn p-1.5 rounded-lg border border-neutral-200 bg-white text-neutral-400 hover:text-red-600 hover:border-red-200 hover:bg-red-50 transition-colors" data-id="${esc(r.id)}" title="Delete">
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
						</svg>
					</button>
				</div>
			</div>`;
		}).join('');

		attachCardListeners();
	}

	/* ── Card listeners ──────────────────────────────────────────── */
	function attachCardListeners() {
		document.querySelectorAll<HTMLButtonElement>('.req-action-btn').forEach(btn => {
			btn.addEventListener('click', async () => {
				const id     = btn.dataset.id!;
				const action = btn.dataset.action as 'read' | 'resolved';
				btn.disabled = true;
				try {
					await updateDoc(doc(db, 'requests', id), { status: action });
					const req = allRequests.find(r => r.id === id);
					if (req) req.status = action;
					renderGrid((document.getElementById('req-filter') as HTMLSelectElement)?.value || 'all');
				} catch (err) { console.error(err); btn.disabled = false; }
			});
		});

		document.querySelectorAll<HTMLButtonElement>('.req-delete-btn').forEach(btn => {
			btn.addEventListener('click', () => {
				deleteTargetId = btn.dataset.id!;
				document.getElementById('req-delete-modal')?.classList.remove('hidden');
			});
		});
	}

	/* ── Delete modal ────────────────────────────────────────────── */
	document.getElementById('req-delete-cancel')?.addEventListener('click', () => {
		deleteTargetId = null;
		document.getElementById('req-delete-modal')?.classList.add('hidden');
	});

	document.getElementById('req-delete-confirm')?.addEventListener('click', async () => {
		if (!deleteTargetId) return;
		const confirmBtn = document.getElementById('req-delete-confirm') as HTMLButtonElement;
		confirmBtn.disabled = true;
		confirmBtn.textContent = 'Deleting…';
		try {
			await deleteDoc(doc(db, 'requests', deleteTargetId));
			allRequests = allRequests.filter(r => r.id !== deleteTargetId);
			deleteTargetId = null;
			document.getElementById('req-delete-modal')?.classList.add('hidden');
			renderGrid((document.getElementById('req-filter') as HTMLSelectElement)?.value || 'all');
		} catch (err) {
			console.error(err);
		} finally {
			confirmBtn.disabled = false;
			confirmBtn.textContent = 'Delete';
		}
	});

	/* ── Filter ──────────────────────────────────────────────────── */
	document.getElementById('req-filter')?.addEventListener('change', (e) => {
		renderGrid((e.target as HTMLSelectElement).value);
	});

	/* ── Load ────────────────────────────────────────────────────── */
	async function loadRequests() {
		const grid = document.getElementById('req-grid')!;
		try {
			const snap = await getDocs(query(collection(db, 'requests'), orderBy('createdAt', 'desc')));
			allRequests = snap.docs.map(d => ({ id: d.id, ...d.data() } as Request));
			renderGrid('all');
		} catch (err) {
			console.error(err);
			grid.innerHTML = `<div class="col-span-full flex items-center justify-center py-16 text-neutral-400 text-sm">Could not load requests.</div>`;
		}
	}

	/* ── Auth guard ──────────────────────────────────────────────── */
	const authEl = document.getElementById('admin-auth-check');
	const observer = new MutationObserver(() => {
		if (authEl?.classList.contains('hidden')) { observer.disconnect(); loadRequests(); }
	});
	if (authEl) observer.observe(authEl, { attributes: true, attributeFilter: ['class'] });
</script>
