---
import AdminLayout from '../../components/AdminLayout.astro';
---

<AdminLayout pageTitle="Tours" pageDescription="All tour bookings." activeSection="tours">

	<div class="bg-white rounded-2xl border border-neutral-200 shadow-sm overflow-hidden">
		<div class="px-6 py-4 border-b border-neutral-100 flex items-center justify-between gap-4">
			<div class="flex items-center gap-3">
				<h2 class="text-base font-semibold text-neutral-800">All Tours</h2>
				<span id="tours-count" class="text-xs text-neutral-400 font-medium"></span>
			</div>
			<button id="add-tour-btn" type="button"
				class="flex items-center gap-2 px-4 py-2 bg-[#0C6B95] hover:bg-[#0a5c82] text-white text-sm font-semibold rounded-xl transition-colors shadow-sm shadow-[#0C6B95]/20">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
					<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
				</svg>
				Add Booking
			</button>
		</div>
		<div class="overflow-x-auto">
			<table class="w-full text-sm">
				<thead>
					<tr class="bg-neutral-50 text-left">
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Date</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Name</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Email</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Tour</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Pickup</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Participants</th>
						<th class="px-6 py-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider">Status</th>
					</tr>
				</thead>
				<tbody id="tours-tbody">
					<tr><td colspan="7" class="px-6 py-10 text-center text-neutral-400">Loading…</td></tr>
				</tbody>
			</table>
		</div>
	</div>

	<!-- Add Booking Modal -->
	<div id="add-tour-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/40 backdrop-blur-sm px-4 py-6">
		<div class="bg-white rounded-2xl shadow-2xl border border-neutral-200 w-full max-w-lg max-h-[90vh] overflow-y-auto">

			<div class="flex items-center justify-between px-6 py-4 border-b border-neutral-100">
				<h3 class="text-lg font-bold text-neutral-900">Add Tour Booking</h3>
				<button id="add-tour-close" type="button" class="p-1.5 rounded-lg hover:bg-neutral-100 text-neutral-400 transition-colors">
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
				</button>
			</div>

			<form id="add-tour-form" class="px-6 py-5 flex flex-col gap-4">

				<div class="grid grid-cols-2 gap-4">
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Full Name *</label>
						<input id="to-name" type="text" placeholder="John Smith" required
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
					</div>
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Email *</label>
						<input id="to-email" type="email" placeholder="john@example.com" required
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
					</div>
				</div>

				<div class="flex flex-col gap-1.5">
					<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Phone</label>
					<input id="to-phone" type="text" placeholder="+30 69..."
						class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
				</div>

				<div class="flex flex-col gap-1.5">
					<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Tour *</label>
					<select id="to-tour"
						class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50">
						<option value="" disabled selected>Loading tours…</option>
					</select>
				</div>

				<div class="flex flex-col gap-1.5">
					<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Pickup Location *</label>
					<input id="to-pickup" type="text" placeholder="Hotel, address or landmark..." required
						class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
				</div>

				<div class="grid grid-cols-2 gap-4">
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Date *</label>
						<input id="to-date" type="date" required
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
					</div>
					<div class="flex flex-col gap-1.5">
						<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Time</label>
						<input id="to-time" type="time"
							class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
					</div>
				</div>

				<div class="flex flex-col gap-1.5">
					<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Participants *</label>
					<input id="to-participants" type="number" min="1" max="60" placeholder="1" required
						class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50" />
				</div>

				<div class="flex flex-col gap-1.5">
					<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Special Requests</label>
					<textarea id="to-notes" rows="2" placeholder="Dietary requirements, preferences..."
						class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50 resize-none"></textarea>
				</div>

				<div class="flex flex-col gap-1.5">
					<label class="text-xs font-semibold text-neutral-500 uppercase tracking-wider">Status</label>
					<select id="to-status"
						class="px-3 py-2.5 border border-neutral-200 rounded-xl text-sm text-neutral-800 focus:outline-none focus:ring-2 focus:ring-[#0C6B95]/20 focus:border-[#0C6B95] bg-neutral-50">
						<option value="new">New</option>
						<option value="pending">Pending</option>
						<option value="payed">Payed</option>
						<option value="planning">Planning</option>
						<option value="cancelled">Cancelled</option>
						<option value="done">Done</option>
					</select>
				</div>

				<p id="to-error" class="hidden text-sm text-red-600"></p>

				<div class="flex gap-3 pt-1">
					<button type="button" id="add-tour-cancel2"
						class="flex-1 py-2.5 rounded-xl border border-neutral-200 text-neutral-700 text-sm font-semibold hover:bg-neutral-50 transition-colors">Cancel</button>
					<button type="submit" id="to-submit"
						class="flex-1 py-2.5 rounded-xl bg-[#0C6B95] hover:bg-[#0a5c82] text-white text-sm font-semibold transition-colors disabled:opacity-60">
						Save Booking
					</button>
				</div>

			</form>
		</div>
	</div>

</AdminLayout>

<script>
	import { db } from '../../lib/firebase';
	import { collection, getDocs, addDoc, updateDoc, doc, orderBy, query, serverTimestamp } from 'firebase/firestore';

	/* ── Status colours ── */
	const STATUS_COLORS: Record<string, string> = {
		new:       'bg-sky-50 text-sky-700 border-sky-200',
		pending:   'bg-amber-50 text-amber-700 border-amber-200',
		payed:     'bg-emerald-50 text-emerald-700 border-emerald-200',
		planning:  'bg-violet-50 text-violet-700 border-violet-200',
		cancelled: 'bg-red-50 text-red-600 border-red-200',
		done:      'bg-neutral-100 text-neutral-600 border-neutral-300',
	};

	const STATUS_OPTIONS = ['new', 'pending', 'payed', 'planning', 'cancelled', 'done'];

	const applySelectColor = (sel: HTMLSelectElement) => {
		const cls = STATUS_COLORS[sel.value] ?? 'bg-neutral-50 text-neutral-600 border-neutral-200';
		sel.className = `status-select appearance-none text-xs font-medium border rounded-full px-2.5 py-0.5 focus:outline-none cursor-pointer capitalize ${cls}`;
	};

	const buildStatusSelect = (docId: string, current: string) => {
		const val = current?.toLowerCase() ?? 'new';
		const opts = STATUS_OPTIONS.map(s =>
			`<option value="${s}" ${val === s ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`
		).join('');
		return `<select class="status-select" data-id="${docId}" data-col="tours">${opts}</select>`;
	};

	/* ── Load tour catalog into the select ── */
	async function loadTourOptions() {
		const sel = document.getElementById('to-tour') as HTMLSelectElement;
		try {
			const snap = await getDocs(query(collection(db, 'toursCatalog'), orderBy('createdAt', 'desc')));
			const published = snap.docs.filter(d => d.data().published !== false);
			sel.innerHTML = published.length === 0
				? '<option value="" disabled selected>No tours available</option>'
				: '<option value="" disabled selected>Select a tour…</option>' +
				  published.map(d => `<option value="${d.id}">${d.data().title ?? '—'}</option>`).join('');
		} catch {
			sel.innerHTML = '<option value="" disabled selected>Could not load tours</option>';
		}
	}

	async function loadTours() {
		const tbody = document.getElementById('tours-tbody')!;
		const countEl = document.getElementById('tours-count');
		try {
			const snap = await getDocs(query(collection(db, 'tours'), orderBy('createdAt', 'desc')));
			if (countEl) countEl.textContent = `${snap.size} record${snap.size !== 1 ? 's' : ''}`;
			if (snap.empty) {
				tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-10 text-center text-neutral-400">No tours found.</td></tr>`;
				return;
			}
			tbody.innerHTML = snap.docs.map(document => {
				const d = document.data() as Record<string, unknown>;
				const date = d.createdAt ? new Date((d.createdAt as { toDate?: () => Date }).toDate?.() ?? 0).toLocaleDateString() : '—';
				return `<tr class="border-t border-neutral-100 hover:bg-neutral-50 transition-colors">
					<td class="px-6 py-3 text-neutral-600 whitespace-nowrap">${date}</td>
					<td class="px-6 py-3 font-medium text-neutral-900 whitespace-nowrap">${d.name ?? '—'}</td>
					<td class="px-6 py-3 text-neutral-500 whitespace-nowrap">${d.email ?? '—'}</td>
					<td class="px-6 py-3 text-neutral-600 whitespace-nowrap">${d.tour ?? d.tourName ?? '—'}</td>
					<td class="px-6 py-3 text-neutral-600">${d.pickup ?? d.pickupLocation ?? '—'}</td>
					<td class="px-6 py-3 text-neutral-600 text-center">${d.participants ?? d.passengers ?? '—'}</td>
					<td class="px-6 py-3">${buildStatusSelect(document.id, String(d.status ?? 'new'))}</td>
				</tr>`;
			}).join('');

			/* Apply colours to all selects */
			document.querySelectorAll<HTMLSelectElement>('.status-select').forEach(applySelectColor);
		} catch {
			tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-10 text-center text-neutral-400">Could not load data.</td></tr>`;
		}
	}

	/* ── Status change delegation ── */
	document.getElementById('tours-tbody')?.addEventListener('change', async (e) => {
		const sel = e.target as HTMLSelectElement;
		if (!sel.classList.contains('status-select')) return;
		const docId = sel.dataset.id!;
		const newStatus = sel.value;
		applySelectColor(sel);
		try {
			await updateDoc(doc(db, 'tours', docId), { status: newStatus });
		} catch (err) {
			console.error('Failed to update status:', err);
		}
	});

	/* ── Modal ── */
	const modal      = document.getElementById('add-tour-modal')!;
	const openModal  = async () => { modal.classList.remove('hidden'); await loadTourOptions(); };
	const closeModal = () => { modal.classList.add('hidden'); (document.getElementById('add-tour-form') as HTMLFormElement)?.reset(); document.getElementById('to-error')!.classList.add('hidden'); };

	document.getElementById('add-tour-btn')?.addEventListener('click', openModal);
	document.getElementById('add-tour-close')?.addEventListener('click', closeModal);
	document.getElementById('add-tour-cancel2')?.addEventListener('click', closeModal);
	modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

	document.getElementById('add-tour-form')?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const errorEl  = document.getElementById('to-error')!;
		const submitBtn = document.getElementById('to-submit') as HTMLButtonElement;
		errorEl.classList.add('hidden');

		const val = (id: string) => (document.getElementById(id) as HTMLInputElement)?.value.trim();

		const name         = val('to-name');
		const email        = val('to-email');
		const phone        = val('to-phone');
		const tourSel      = document.getElementById('to-tour') as HTMLSelectElement;
		const tourId       = tourSel.value;
		const tourName     = tourId ? tourSel.options[tourSel.selectedIndex]?.text : '';
		const pickup       = val('to-pickup');
		const date         = val('to-date');
		const time         = val('to-time');
		const participants = parseInt(val('to-participants') || '1', 10);
		const notes        = val('to-notes');
		const status       = val('to-status') || 'new';

		if (!name || !email || !tourId || !pickup || !date || !participants) {
			errorEl.textContent = 'Please fill in all required fields.';
			errorEl.classList.remove('hidden');
			return;
		}

		submitBtn.disabled = true;
		submitBtn.textContent = 'Saving…';
		try {
			await addDoc(collection(db, 'tours'), {
				name, email, phone: phone || '',
				tour: tourName, tourId,
				pickup, pickupLocation: pickup,
				date, time: time || '',
				participants,
				specialRequests: notes || '',
				status,
				createdAt: serverTimestamp(),
				addedByAdmin: true,
			});
			closeModal();
			await loadTours();
		} catch (err) {
			console.error(err);
			errorEl.textContent = 'Failed to save. Please try again.';
			errorEl.classList.remove('hidden');
		} finally {
			submitBtn.disabled = false;
			submitBtn.textContent = 'Save Booking';
		}
	});

	/* ── Auth guard ── */
	const authEl = document.getElementById('admin-auth-check');
	const observer = new MutationObserver(() => {
		if (authEl?.classList.contains('hidden')) { observer.disconnect(); loadTours(); }
	});
	if (authEl) observer.observe(authEl, { attributes: true, attributeFilter: ['class'] });
</script>
